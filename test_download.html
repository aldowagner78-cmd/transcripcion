<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Test Descarga RTF</title>
    <style>
        body { font-family: Arial; padding: 40px; background: #f0f0f0; }
        .test-box { background: white; padding: 30px; border-radius: 10px; max-width: 600px; margin: 0 auto; }
        button { background: #0f766e; color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 10px 5px; }
        button:hover { background: #0d5c56; }
        .result { margin-top: 20px; padding: 15px; border-radius: 8px; }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        pre { background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="test-box">
        <h1>üß™ Test de Descarga</h1>
        <p>Prueba de generaci√≥n de archivos descargables</p>
        
        <button onclick="testRTF()">üìÑ Probar RTF</button>
        <button onclick="testTXT()">üìù Probar TXT</button>
        <button onclick="testHTML()">üåê Probar HTML</button>
        
        <div id="result"></div>
    </div>

    <script>
        const testText = `Este es un texto de prueba para verificar la descarga.
Incluye tildes: √°√©√≠√≥√∫ √Å√â√ç√ì√ö
Y e√±es: √± √ë
N√∫meros: 1234567890
Signos: ¬ø? ¬°! @ # $ % & * ( )

Paciente: Juan P√©rez
Diagn√≥stico: Examen m√©dico de rutina
Observaciones: El paciente presenta signos normales.`;

        function showResult(message, isSuccess) {
            const result = document.getElementById('result');
            result.className = 'result ' + (isSuccess ? 'success' : 'error');
            result.innerHTML = message;
        }

        function testRTF() {
            try {
                const fecha = new Date().toLocaleDateString('es-ES');
                const rtfContent = createRTF(testText, fecha);
                
                console.log('RTF generado:', rtfContent);
                
                const blob = new Blob([rtfContent], { type: 'application/rtf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'test_informe.rtf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showResult('‚úÖ RTF descargado correctamente!<br><br>Contenido generado:<pre>' + escapeHtml(rtfContent.substring(0, 500)) + '...</pre>', true);
            } catch (e) {
                showResult('‚ùå Error RTF: ' + e.message + '<pre>' + e.stack + '</pre>', false);
            }
        }

        function testTXT() {
            try {
                const blob = new Blob([testText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'test_informe.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showResult('‚úÖ TXT descargado correctamente!', true);
            } catch (e) {
                showResult('‚ùå Error TXT: ' + e.message, false);
            }
        }

        function testHTML() {
            try {
                const htmlContent = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>Informe M√©dico</title>
<style>body{font-family:Georgia,serif;max-width:800px;margin:40px auto;padding:20px;line-height:1.8;}
h1{text-align:center;border-bottom:2px solid #333;padding-bottom:10px;}
.fecha{text-align:center;color:#666;font-style:italic;}</style></head>
<body><h1>INFORME M√âDICO</h1>
<p class="fecha">Fecha: ${new Date().toLocaleDateString('es-ES')}</p>
<div>${testText.split('\n').map(l => '<p>' + l + '</p>').join('')}</div>
</body></html>`;

                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'test_informe.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showResult('‚úÖ HTML descargado correctamente!', true);
            } catch (e) {
                showResult('‚ùå Error HTML: ' + e.message, false);
            }
        }

        function createRTF(text, fecha) {
            const lines = text.split('\n');
            let rtfBody = '';
            
            for (const line of lines) {
                const escaped = line
                    .replace(/\\/g, '\\\\')
                    .replace(/\{/g, '\\{')
                    .replace(/\}/g, '\\}')
                    .replace(/[√°√†√§√¢]/g, "\\'e1")
                    .replace(/[√©√®√´√™]/g, "\\'e9")
                    .replace(/[√≠√¨√Ø√Æ]/g, "\\'ed")
                    .replace(/[√≥√≤√∂√¥]/g, "\\'f3")
                    .replace(/[√∫√π√º√ª]/g, "\\'fa")
                    .replace(/√±/g, "\\'f1")
                    .replace(/√ë/g, "\\'d1")
                    .replace(/[√Å√Ä√Ñ√Ç]/g, "\\'c1")
                    .replace(/[√â√à√ã√ä]/g, "\\'c9")
                    .replace(/[√ç√å√è√é]/g, "\\'cd")
                    .replace(/[√ì√í√ñ√î]/g, "\\'d3")
                    .replace(/[√ö√ô√ú√õ]/g, "\\'da");
                rtfBody += escaped + '\\par\n';
            }

            return `{\\rtf1\\ansi\\deff0
{\\fonttbl{\\f0 Arial;}{\\f1 Times New Roman;}}
{\\colortbl;\\red0\\green0\\blue0;\\red102\\green102\\blue102;}
\\paperw12240\\paperh15840\\margl1440\\margr1440\\margt1440\\margb1440
\\qc\\f0\\fs36\\b INFORME M\\'c9DICO\\b0\\par
\\fs24\\cf2\\i Fecha: ${fecha}\\i0\\cf1\\par
\\par
\\ql\\f1\\fs24
${rtfBody}
}`;
        }

        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }
    </script>
</body>
</html>
