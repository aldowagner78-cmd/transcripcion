<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcriptor M√©dico | Audio a Texto</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=Crimson+Pro:wght@400;500;600&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.2.4/docx.umd.min.js"></script>
    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';
        window.pipeline = pipeline;
    </script>
    <style>
        :root {
            --primary: #0f766e;
            --primary-light: #14b8a6;
            --primary-dark: #0d5c56;
            --accent: #f59e0b;
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Instrument Sans', -apple-system, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 42px;
            height: 42px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-sm);
            display: grid;
            place-items: center;
            backdrop-filter: blur(10px);
        }

        .logo-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .logo-text {
            color: white;
        }

        .logo-text h1 {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .logo-text span {
            font-size: 0.75rem;
            opacity: 0.8;
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 2rem;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            padding: 1.5rem;
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title svg {
            width: 18px;
            height: 18px;
            fill: var(--primary);
        }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            padding: 2.5rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.02) 0%, rgba(15, 118, 110, 0.05) 100%);
            position: relative;
            overflow: hidden;
        }

        .drop-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .drop-zone.dragover::before {
            opacity: 0.1;
        }

        .drop-zone-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 50%;
            display: grid;
            place-items: center;
            position: relative;
            z-index: 1;
        }

        .drop-zone-icon svg {
            width: 28px;
            height: 28px;
            fill: white;
        }

        .drop-zone-text {
            position: relative;
            z-index: 1;
        }

        .drop-zone-text h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .drop-zone-text p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .drop-zone-text small {
            display: block;
            margin-top: 0.75rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .file-input {
            display: none;
        }

        /* File List */
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-main);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .file-item-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent) 0%, #f97316 100%);
            border-radius: var(--radius-sm);
            display: grid;
            place-items: center;
            flex-shrink: 0;
        }

        .file-item-icon svg {
            width: 18px;
            height: 18px;
            fill: white;
        }

        .file-item-info {
            flex: 1;
            min-width: 0;
        }

        .file-item-name {
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-item-size {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .file-item-remove {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 50%;
            display: grid;
            place-items: center;
            transition: all 0.2s ease;
        }

        .file-item-remove:hover {
            background: #fee2e2;
        }

        .file-item-remove svg {
            width: 16px;
            height: 16px;
            fill: #ef4444;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            text-decoration: none;
        }

        .btn svg {
            width: 18px;
            height: 18px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(15, 118, 110, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(15, 118, 110, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-main);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-secondary svg {
            fill: currentColor;
        }

        .btn-accent {
            background: linear-gradient(135deg, var(--accent) 0%, #f97316 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .btn-accent:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .btn-full {
            width: 100%;
        }

        /* Processing Status */
        .processing-status {
            display: none;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.05) 0%, rgba(15, 118, 110, 0.1) 100%);
            border-radius: var(--radius-md);
            border: 1px solid rgba(15, 118, 110, 0.2);
            margin-top: 1rem;
        }

        .processing-status.active {
            display: flex;
        }

        .processing-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .processing-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .processing-text {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--primary-dark);
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Model Loading Notice */
        .model-notice {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: var(--radius-sm);
            padding: 0.75rem;
            font-size: 0.8rem;
            color: #92400e;
            margin-top: 1rem;
            display: none;
        }

        .model-notice.active {
            display: block;
        }

        /* Editor Area */
        .editor-area {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .editor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        /* Tabs */
        .tabs-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            padding: 0.5rem 1rem 0;
            display: none;
            gap: 0.5rem;
            overflow-x: auto;
            white-space: nowrap;
        }

        .tabs-container.active {
            display: flex;
        }

        .tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }

        .tab:hover {
            color: var(--primary);
            background: var(--bg-main);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        .tab-close {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            margin-left: 0.25rem;
            opacity: 0.5;
        }

        .tab-close:hover {
            opacity: 1;
            background: rgba(239, 68, 68, 0.1);
        }

        .tab-close svg {
            width: 12px;
            height: 12px;
            fill: currentColor;
        }

        .editor-title {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .editor-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .editor-toolbar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-bottom: none;
            border-radius: 0;
        }

        .editor-toolbar.no-tabs {
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .toolbar-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: grid;
            place-items: center;
            transition: all 0.2s ease;
        }

        .toolbar-btn:hover {
            background: var(--bg-main);
        }

        .toolbar-btn svg {
            width: 18px;
            height: 18px;
            fill: var(--text-secondary);
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: var(--border);
            margin: 0 0.5rem;
        }

        .word-count {
            margin-left: auto;
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: var(--bg-main);
            padding: 0.375rem 0.75rem;
            border-radius: 999px;
        }

        .editor-content {
            flex: 1;
            min-height: 500px;
            padding: 2rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.125rem;
            line-height: 1.8;
            color: var(--text-primary);
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .editor-content:focus {
            box-shadow: inset 0 0 0 2px rgba(15, 118, 110, 0.2);
        }

        .editor-content:empty::before {
            content: attr(data-placeholder);
            color: var(--text-secondary);
            opacity: 0.6;
            font-style: italic;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }

            .header,
            .sidebar,
            .editor-toolbar,
            .editor-actions {
                display: none !important;
            }

            .main-container {
                display: block;
                padding: 0;
                max-width: none;
            }

            .editor-content {
                border: none;
                padding: 0;
                min-height: auto;
                font-size: 12pt;
                line-height: 1.6;
            }

            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 2rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid #333;
            }

            .print-header h1 {
                font-family: 'Crimson Pro', Georgia, serif;
                font-size: 18pt;
                margin-bottom: 0.5rem;
            }

            .print-header p {
                font-size: 10pt;
                color: #666;
            }

            .print-footer {
                display: block !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                text-align: center;
                font-size: 9pt;
                color: #999;
                padding: 1rem;
                border-top: 1px solid #ddd;
            }
        }

        .print-header,
        .print-footer {
            display: none;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: -1;
            }
        }

        @media (max-width: 600px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .main-container {
                padding: 1rem;
            }

            .editor-actions {
                width: 100%;
            }

            .editor-actions .btn {
                flex: 1;
            }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--text-primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .toast svg {
            width: 20px;
            height: 20px;
            fill: white;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
                    </svg>
                </div>
                <div class="logo-text">
                    <h1>Transcriptor M√©dico</h1>
                    <span>Audio ‚Üí Texto | Powered by Whisper AI</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="showHelp()">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z" />
                    </svg>
                    Ayuda
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <main class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Upload Card -->
            <div class="card">
                <div class="card-title">
                    <svg viewBox="0 0 24 24">
                        <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z" />
                    </svg>
                    Subir Audio
                </div>
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-icon">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
                        </svg>
                    </div>
                    <div class="drop-zone-text">
                        <h3>Arrastra tu audio aqu√≠</h3>
                        <p>o haz clic para seleccionar</p>
                        <small>MP3, WAV, OGG, M4A, WEBM, FLAC</small>
                    </div>
                    <input type="file" class="file-input" id="fileInput"
                        accept="audio/*,.ogg,.mp3,.wav,.m4a,.webm,.flac,.aac,.wma,.opus" multiple>
                </div>

                <div class="file-list" id="fileList"></div>

                <div class="model-notice" id="modelNotice">
                    ‚ö° Descargando modelo de alta precisi√≥n (~150MB). Solo la primera vez. Los resultados aparecen progresivamente.
                </div>

                <div class="processing-status" id="processingStatus">
                    <div class="processing-header">
                        <div class="processing-spinner"></div>
                        <span class="processing-text" id="processingText">Procesando audio...</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <button class="btn btn-primary btn-full" id="transcribeBtn" disabled style="margin-top: 1rem;">
                    <svg viewBox="0 0 24 24" fill="white">
                        <path
                            d="M12 15c1.66 0 2.99-1.34 2.99-3L15 6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 15 6.7 12H5c0 3.42 2.72 6.23 6 6.72V22h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z" />
                    </svg>
                    Transcribir Audio
                </button>
                <button class="btn btn-secondary btn-full" id="resetBtn" style="margin-top: 0.75rem;">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M19 8l-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3l-4-4zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4H6z" />
                    </svg>
                    Limpiar / Nuevo Informe
                </button>
            </div>

            <!-- Tips Card -->
            <div class="card">
                <div class="card-title">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 017 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z" />
                    </svg>
                    Consejos
                </div>
                <ul
                    style="font-size: 0.875rem; color: var(--text-secondary); padding-left: 1.25rem; display: flex; flex-direction: column; gap: 0.5rem;">
                    <li>Audio claro mejora la precisi√≥n</li>
                    <li>Funciona 100% offline despu√©s de cargar</li>
                    <li>Revisa t√©rminos m√©dicos espec√≠ficos</li>
                    <li>Edita directamente en el texto</li>
                </ul>
            </div>
        </aside>

        <!-- Editor Area -->
        <section class="editor-area">
            <div class="editor-header">
                <h2 class="editor-title">Informes M√©dicos Transcritos</h2>
                <div class="editor-actions">
                    <button class="btn btn-secondary" id="copyBtn" disabled>
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
                        </svg>
                        Copiar
                    </button>
                    <button class="btn btn-accent" id="downloadBtn" disabled>
                        <svg viewBox="0 0 24 24" fill="white">
                            <path
                                d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" />
                        </svg>
                        Descargar Word
                    </button>
                    <button class="btn btn-secondary" id="printBtn" disabled>
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z" />
                        </svg>
                        Imprimir
                    </button>
                </div>
            </div>

            <div class="editor-container">
                <div class="tabs-container" id="tabsContainer"></div>
                <div class="editor-toolbar" id="editorToolbar">
                    <button class="toolbar-btn" title="Negrita" onclick="formatText('bold')">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M15.6 10.79c.97-.67 1.65-1.77 1.65-2.79 0-2.26-1.75-4-4-4H7v14h7.04c2.09 0 3.71-1.7 3.71-3.79 0-1.52-.86-2.82-2.15-3.42zM10 6.5h3c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-3v-3zm3.5 9H10v-3h3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z" />
                        </svg>
                    </button>
                    <button class="toolbar-btn" title="Cursiva" onclick="formatText('italic')">
                        <svg viewBox="0 0 24 24">
                            <path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z" />
                        </svg>
                    </button>
                    <button class="toolbar-btn" title="Subrayado" onclick="formatText('underline')">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M12 17c3.31 0 6-2.69 6-6V3h-2.5v8c0 1.93-1.57 3.5-3.5 3.5S8.5 12.93 8.5 11V3H6v8c0 3.31 2.69 6 6 6zm-7 2v2h14v-2H5z" />
                        </svg>
                    </button>
                    <div class="toolbar-divider"></div>
                    <button class="toolbar-btn" title="Limpiar formato" onclick="formatText('removeFormat')">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M3.27 5L2 6.27l6.97 6.97L6.5 19h3l1.57-3.66L16.73 21 18 19.73 3.55 5.27 3.27 5zM6 5v.18L8.82 8h2.4l-.72 1.68 2.1 2.1L14.21 8H20V5H6z" />
                        </svg>
                    </button>
                    <span class="word-count" id="wordCount">0 palabras</span>
                </div>
                <div class="editor-content" id="editor" contenteditable="true"
                    data-placeholder="El texto transcrito aparecer√° aqu√≠. Puedes editarlo directamente..."></div>
            </div>
        </section>
    </main>

    <!-- Print Header/Footer -->
    <div class="print-header">
        <h1>INFORME M√âDICO</h1>
        <p id="printDate"></p>
    </div>
    <div class="print-footer">
        Documento generado por Transcriptor M√©dico | <span id="printDateFooter"></span>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <svg viewBox="0 0 24 24">
            <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z" />
        </svg>
        <span id="toastMessage">Operaci√≥n completada</span>
    </div>

    <script>
        // Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const transcribeBtn = document.getElementById('transcribeBtn');
        const processingStatus = document.getElementById('processingStatus');
        const processingText = document.getElementById('processingText');
        const progressFill = document.getElementById('progressFill');
        const modelNotice = document.getElementById('modelNotice');
        const editor = document.getElementById('editor');
        const wordCount = document.getElementById('wordCount');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const printBtn = document.getElementById('printBtn');
        const resetBtn = document.getElementById('resetBtn');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');

        let uploadedFiles = [];
        let transcriber = null;
        let transcriptions = [];
        let activeTranscriptionIndex = 0;

        // Drop Zone Events
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Handle Files
        function handleFiles(files) {
            const validExtensions = ['.mp3', '.wav', '.ogg', '.m4a', '.webm', '.flac', '.aac', '.wma', '.opus'];

            const audioFiles = Array.from(files).filter(file => {
                if (file.type.startsWith('audio/')) return true;
                const fileName = file.name.toLowerCase();
                return validExtensions.some(ext => fileName.endsWith(ext));
            });

            if (audioFiles.length === 0) {
                showToast('Por favor, sube archivos de audio v√°lidos', 'error');
                return;
            }

            uploadedFiles = [...uploadedFiles, ...audioFiles];
            updateFileList();
            transcribeBtn.disabled = false;

            // Show notice only if not previously loaded
            if (!localStorage.getItem('whisper_model_loaded')) {
                modelNotice.classList.add('active');
            }
        }

        // Update File List UI
        function updateFileList() {
            fileList.innerHTML = uploadedFiles.map((file, index) => `
                <div class="file-item">
                    <div class="file-item-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                    </div>
                    <div class="file-item-info">
                        <div class="file-item-name">${file.name}</div>
                        <div class="file-item-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button class="file-item-remove" onclick="removeFile(${index})">
                        <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                    </button>
                </div>
            `).join('');
        }

        // Remove File
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
            transcribeBtn.disabled = uploadedFiles.length === 0;
            if (uploadedFiles.length === 0) {
                modelNotice.classList.remove('active');
            }
        }

        // Format File Size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Load Whisper Model
        async function loadModel() {
            if (transcriber) return transcriber;

            processingText.textContent = 'Cargando modelo Whisper Small (alta precisi√≥n)...';
            progressFill.style.width = '20%';

            try {
                // Use Whisper Small for medical precision
                transcriber = await window.pipeline('automatic-speech-recognition', 'Xenova/whisper-small', {
                    progress_callback: (progress) => {
                        if (progress.status === 'downloading') {
                            const percent = Math.round((progress.loaded / progress.total) * 100);
                            processingText.textContent = `Descargando modelo: ${percent}% (~150MB, solo primera vez)`;
                            progressFill.style.width = `${20 + (percent * 0.3)}%`;
                        }
                    }
                });

                modelNotice.classList.remove('active');
                localStorage.setItem('whisper_model_loaded', 'true');
                return transcriber;
            } catch (error) {
                console.error('Error loading model:', error);
                throw new Error('No se pudo cargar el modelo de transcripci√≥n');
            }
        }

        // Convert audio file to format Whisper can process
        async function audioToFloat32(file) {
            const arrayBuffer = await file.arrayBuffer();
            const audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            // Get audio data as float32
            const audioData = audioBuffer.getChannelData(0);

            // Close the audio context
            await audioContext.close();

            return audioData;
        }

        // Transcribe Audio (progressive sequential processing)
        transcribeBtn.addEventListener('click', async () => {
            if (uploadedFiles.length === 0) return;

            processingStatus.classList.add('active');
            transcribeBtn.disabled = true;
            progressFill.style.width = '10%';
            transcriptions = [];
            activeTranscriptionIndex = 0;

            try {
                // Load model if not loaded
                await loadModel();

                // Process files ONE BY ONE and show results progressively
                for (let i = 0; i < uploadedFiles.length; i++) {
                    const file = uploadedFiles[i];
                    processingText.textContent = `Transcribiendo ${i + 1}/${uploadedFiles.length}: ${file.name}`;
                    
                    const baseProgress = 30 + ((i / uploadedFiles.length) * 60);
                    progressFill.style.width = `${baseProgress}%`;

                    try {
                        // Convert audio to float32 array
                        const audioData = await audioToFloat32(file);

                        // Transcribe with Whisper Small (high precision)
                        const result = await transcriber(audioData, {
                            language: 'es',
                            task: 'transcribe',
                            chunk_length_s: 30,
                            stride_length_s: 5,
                            return_timestamps: false
                        });

                        // Add transcription immediately
                        transcriptions.push({
                            fileName: file.name,
                            text: result.text || 'No se detect√≥ audio hablado.',
                            success: true
                        });
                    } catch (error) {
                        console.error(`Error transcribing ${file.name}:`, error);
                        transcriptions.push({
                            fileName: file.name,
                            text: `Error al transcribir: ${error.message}`,
                            success: false
                        });
                    }
                    
                    // SHOW RESULT IMMEDIATELY after each file
                    if (i === 0) {
                        // First file: show it
                        editor.innerHTML = transcriptions[0].text;
                        updateWordCount();
                        copyBtn.disabled = false;
                        downloadBtn.disabled = false;
                        printBtn.disabled = false;
                    }
                    
                    // Update tabs progressively
                    createTabs();
                    
                    progressFill.style.width = `${baseProgress + (60 / uploadedFiles.length)}%`;
                }

                progressFill.style.width = '100%';
                processingText.textContent = `‚úì ${transcriptions.length} transcripci√≥n(es) completada(s)`;

                setTimeout(() => {
                    processingStatus.classList.remove('active');
                    showToast(`${transcriptions.length} archivo(s) transcrito(s) exitosamente`, 'success');
                }, 500);

            } catch (error) {
                console.error('Error:', error);
                processingStatus.classList.remove('active');
                showToast('Error: ' + error.message, 'error');
            }

            transcribeBtn.disabled = false;
        });


        // Update Word Count
        function updateWordCount() {
            const text = editor.innerText.trim();
            const words = text ? text.split(/\s+/).length : 0;
            wordCount.textContent = `${words} palabras`;
            
            // Save current transcription content
            if (transcriptions.length > 0 && activeTranscriptionIndex < transcriptions.length) {
                transcriptions[activeTranscriptionIndex].text = editor.innerHTML;
            }
        }

        editor.addEventListener('input', updateWordCount);

        // Create Tabs
        function createTabs() {
            const tabsContainer = document.getElementById('tabsContainer');
            const editorToolbar = document.getElementById('editorToolbar');
            
            if (transcriptions.length <= 1) {
                tabsContainer.classList.remove('active');
                editorToolbar.classList.add('no-tabs');
                return;
            }

            tabsContainer.classList.add('active');
            editorToolbar.classList.remove('no-tabs');
            
            tabsContainer.innerHTML = transcriptions.map((t, index) => `
                <button class="tab ${index === activeTranscriptionIndex ? 'active' : ''}" onclick="switchToTranscription(${index})">
                    ${truncateFileName(t.fileName)}
                    <span class="tab-close" onclick="event.stopPropagation(); closeTab(${index})">
                        <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                    </span>
                </button>
            `).join('');
        }

        // Switch to Transcription
        function switchToTranscription(index) {
            if (index < 0 || index >= transcriptions.length) return;
            
            // Save current content before switching
            if (transcriptions.length > 0 && activeTranscriptionIndex < transcriptions.length) {
                transcriptions[activeTranscriptionIndex].text = editor.innerHTML;
            }
            
            activeTranscriptionIndex = index;
            editor.innerHTML = transcriptions[index].text;
            updateWordCount();
            createTabs();
        }

        // Close Tab
        function closeTab(index) {
            if (transcriptions.length <= 1) {
                // Last tab, reset everything
                transcriptions = [];
                editor.innerHTML = '';
                document.getElementById('tabsContainer').classList.remove('active');
                document.getElementById('editorToolbar').classList.add('no-tabs');
                copyBtn.disabled = true;
                downloadBtn.disabled = true;
                printBtn.disabled = true;
                updateWordCount();
                return;
            }

            transcriptions.splice(index, 1);
            
            if (activeTranscriptionIndex >= index && activeTranscriptionIndex > 0) {
                activeTranscriptionIndex--;
            }
            
            if (activeTranscriptionIndex >= transcriptions.length) {
                activeTranscriptionIndex = transcriptions.length - 1;
            }
            
            switchToTranscription(activeTranscriptionIndex);
        }

        // Truncate file name for tabs
        function truncateFileName(fileName) {
            const maxLength = 20;
            if (fileName.length <= maxLength) return fileName;
            const ext = fileName.split('.').pop();
            const nameWithoutExt = fileName.substring(0, fileName.lastIndexOf('.'));
            return nameWithoutExt.substring(0, maxLength - ext.length - 4) + '...' + ext;
        }

        // Format Text
        function formatText(command) {
            document.execCommand(command, false, null);
            editor.focus();
        }

        // Copy to Clipboard
        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(editor.innerText);
                showToast('Texto copiado al portapapeles', 'success');
            } catch (error) {
                showToast('Error al copiar', 'error');
            }
        });

        // Download as Word
        downloadBtn.addEventListener('click', async () => {
            try {
                const { Document, Packer, Paragraph, TextRun, AlignmentType, BorderStyle } = docx;

                // Get content from editor and clean it
                const content = editor.innerText || editor.textContent;
                const lines = content.split('\n').filter(line => line.trim());

                // Get file name if available
                const fileName = transcriptions.length > 0 && activeTranscriptionIndex < transcriptions.length
                    ? transcriptions[activeTranscriptionIndex].fileName.replace(/\.[^/.]+$/, '')
                    : 'informe_medico';

                const docParagraphs = [
                    new Paragraph({
                        children: [
                            new TextRun({
                                text: 'INFORME M√âDICO',
                                bold: true,
                                size: 32,
                            }),
                        ],
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 400 },
                    }),
                    new Paragraph({
                        children: [
                            new TextRun({
                                text: `Fecha: ${new Date().toLocaleDateString('es-ES', {
                                    weekday: 'long',
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                })}`,
                                size: 22,
                                color: '666666',
                            }),
                        ],
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 400 },
                        border: {
                            bottom: {
                                color: '999999',
                                space: 10,
                                size: 6,
                                style: BorderStyle.SINGLE,
                            },
                        },
                    }),
                    new Paragraph({ spacing: { after: 200 } }),
                ];

                // Add content paragraphs
                lines.forEach(line => {
                    if (line.trim()) {
                        docParagraphs.push(
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: line,
                                        size: 24,
                                    }),
                                ],
                                spacing: { after: 200 },
                            })
                        );
                    }
                });

                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: docParagraphs,
                    }],
                });

                const blob = await Packer.toBlob(doc);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${fileName}_${new Date().toISOString().split('T')[0]}.docx`;
                a.click();
                URL.revokeObjectURL(url);

                showToast('Documento Word descargado', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al crear documento: ' + error.message, 'error');
            }
        });

        // Print
        printBtn.addEventListener('click', () => {
            const now = new Date().toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('printDate').textContent = now;
            document.getElementById('printDateFooter').textContent = now;
            window.print();
        });

        // Reset App
        resetBtn.addEventListener('click', () => {
            // Clear files
            uploadedFiles = [];
            updateFileList();
            fileInput.value = '';

            // Clear transcriptions and tabs
            transcriptions = [];
            activeTranscriptionIndex = 0;
            document.getElementById('tabsContainer').classList.remove('active');
            document.getElementById('editorToolbar').classList.add('no-tabs');

            // Clear editor
            editor.innerHTML = '';
            wordCount.textContent = '0 palabras';

            // Reset state
            transcribeBtn.disabled = true;
            copyBtn.disabled = true;
            downloadBtn.disabled = true;
            printBtn.disabled = true;
            processingStatus.classList.remove('active');
            modelNotice.classList.remove('active');

            showToast('Aplicaci√≥n lista para nuevo informe', 'success');
        });

        // Show Toast
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Show Help
        function showHelp() {
            const helpContent = `
                <h3 style="margin-bottom: 1rem;">üìã Instrucciones de Uso</h3>
                <ol style="padding-left: 1.25rem; line-height: 1.8;">
                    <li><strong>Subir Audios:</strong> Arrastra o haz clic para seleccionar m√∫ltiples archivos</li>
                    <li><strong>Transcribir:</strong> Los audios se procesan uno por uno (la primera vez descarga el modelo)</li>
                    <li><strong>Pesta√±as:</strong> Navega entre diferentes transcripciones con las pesta√±as</li>
                    <li><strong>Editar:</strong> El texto es editable directamente en cada pesta√±a</li>
                    <li><strong>Exportar:</strong> Descarga como Word o imprime la transcripci√≥n activa</li>
                </ol>
                <p style="margin-top: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 8px; font-size: 0.875rem;">
                    <strong>üí° Nota:</strong> Usa Whisper AI que funciona 100% en tu navegador. No se env√≠a nada a servidores externos.
                </p>
                <p style="margin-top: 0.5rem; padding: 0.75rem; background: #dcfce7; border-radius: 8px; font-size: 0.875rem;">
                    <strong>‚ö° Procesamiento:</strong> Los audios se transcriben secuencialmente para mantener el navegador fluido.
                </p>
            `;

            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: grid; place-items: center; z-index: 1000;">
                    <div style="background: white; padding: 2rem; border-radius: 20px; max-width: 500px; margin: 1rem; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                        ${helpContent}
                        <button class="btn btn-primary" style="margin-top: 1.5rem; width: 100%;" onclick="this.closest('div').parentElement.remove()">Entendido</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
    </script>
</body>

</html>