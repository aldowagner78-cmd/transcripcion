<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcriptor M√©dico | Audio a Texto</title>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=Crimson+Pro:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f766e;
            --primary-light: #14b8a6;
            --primary-dark: #0d5c56;
            --accent: #f59e0b;
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Instrument Sans', -apple-system, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo { display: flex; align-items: center; gap: 0.75rem; }

        .logo-icon {
            width: 42px;
            height: 42px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-sm);
            display: grid;
            place-items: center;
        }

        .logo-icon svg { width: 24px; height: 24px; fill: white; }

        .logo-text { color: white; }
        .logo-text h1 { font-size: 1.25rem; font-weight: 600; }
        .logo-text span { font-size: 0.75rem; opacity: 0.8; }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 2rem;
            min-height: calc(100vh - 80px);
        }

        .sidebar { display: flex; flex-direction: column; gap: 1.5rem; }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            padding: 1.5rem;
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title svg { width: 18px; height: 18px; fill: var(--primary); }

        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            padding: 2.5rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.02) 0%, rgba(15, 118, 110, 0.05) 100%);
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .drop-zone-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 50%;
            display: grid;
            place-items: center;
        }

        .drop-zone-icon svg { width: 28px; height: 28px; fill: white; }

        .drop-zone-text h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem; }
        .drop-zone-text p { font-size: 0.875rem; color: var(--text-secondary); }
        .drop-zone-text small { display: block; margin-top: 0.75rem; font-size: 0.75rem; color: var(--text-secondary); }

        .file-input { display: none; }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-main);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .file-item-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent) 0%, #f97316 100%);
            border-radius: var(--radius-sm);
            display: grid;
            place-items: center;
        }

        .file-item-icon svg { width: 16px; height: 16px; fill: white; }
        .file-item-icon.done { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .file-item-icon.processing { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); }

        .file-item-info { flex: 1; min-width: 0; }
        .file-item-name { font-size: 0.8rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-item-status { font-size: 0.7rem; color: var(--text-secondary); }

        .file-item-remove {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 50%;
            display: grid;
            place-items: center;
        }

        .file-item-remove:hover { background: #fee2e2; }
        .file-item-remove svg { width: 14px; height: 14px; fill: #ef4444; }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn svg { width: 18px; height: 18px; }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(15, 118, 110, 0.3);
        }

        .btn-primary:hover { transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover { background: var(--bg-main); border-color: var(--primary); color: var(--primary); }
        .btn-secondary svg { fill: currentColor; }

        .btn-accent {
            background: linear-gradient(135deg, var(--accent) 0%, #f97316 100%);
            color: white;
        }

        .btn-full { width: 100%; }

        .processing-status {
            display: none;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.05) 0%, rgba(15, 118, 110, 0.1) 100%);
            border-radius: var(--radius-md);
            margin-top: 1rem;
        }

        .processing-status.active { display: flex; }

        .processing-header { display: flex; align-items: center; gap: 0.75rem; }

        .processing-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .processing-text { font-size: 0.8rem; font-weight: 500; color: var(--primary-dark); }

        .progress-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary-light)); width: 0%; transition: width 0.3s; }

        .editor-area { display: flex; flex-direction: column; gap: 1rem; }

        .editor-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }

        .tabs-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            padding: 0.5rem 1rem 0;
            display: none;
            gap: 0.25rem;
            overflow-x: auto;
        }

        .tabs-container.active { display: flex; }

        .tab {
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab:hover { color: var(--primary); background: var(--bg-main); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }

        .tab-close { width: 14px; height: 14px; border-radius: 50%; display: grid; place-items: center; opacity: 0.5; }
        .tab-close:hover { opacity: 1; background: rgba(239, 68, 68, 0.1); }
        .tab-close svg { width: 10px; height: 10px; fill: currentColor; }

        .editor-title { font-family: 'Crimson Pro', Georgia, serif; font-size: 1.5rem; font-weight: 600; }

        .editor-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; }

        .editor-container { flex: 1; display: flex; flex-direction: column; }

        .editor-toolbar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-bottom: none;
        }

        .editor-toolbar.no-tabs { border-radius: var(--radius-md) var(--radius-md) 0 0; }

        .toolbar-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: grid;
            place-items: center;
        }

        .toolbar-btn:hover { background: var(--bg-main); }
        .toolbar-btn svg { width: 16px; height: 16px; fill: var(--text-secondary); }

        .toolbar-divider { width: 1px; height: 20px; background: var(--border); margin: 0 0.25rem; }

        .word-count { margin-left: auto; font-size: 0.7rem; color: var(--text-secondary); background: var(--bg-main); padding: 0.25rem 0.5rem; border-radius: 999px; }

        .editor-content {
            flex: 1;
            min-height: 500px;
            padding: 2rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.125rem;
            line-height: 1.8;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .editor-content:focus { box-shadow: inset 0 0 0 2px rgba(15, 118, 110, 0.2); }
        .editor-content:empty::before { content: attr(data-placeholder); color: var(--text-secondary); opacity: 0.6; font-style: italic; }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--text-primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); }
        .toast.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .toast svg { width: 20px; height: 20px; fill: white; }

        .print-header, .print-footer { display: none; }

        @media print {
            .header, .sidebar, .editor-toolbar, .editor-actions, .tabs-container { display: none !important; }
            .main-container { display: block; padding: 0; }
            .editor-content { border: none; padding: 0; min-height: auto; }
            .print-header { display: block !important; text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #333; }
        }

        @media (max-width: 1024px) {
            .main-container { grid-template-columns: 1fr; }
            .sidebar { order: -1; }
        }

        @media (max-width: 600px) {
            .header-content { flex-direction: column; gap: 1rem; }
            .main-container { padding: 1rem; }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                </div>
                <div class="logo-text">
                    <h1>Transcriptor M√©dico</h1>
                    <span>Audio ‚Üí Texto | Ultra R√°pido con IA</span>
                </div>
            </div>
        </div>
    </header>

    <main class="main-container">
        <aside class="sidebar">
            <div class="card">
                <div class="card-title">
                    <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                    Subir Audios
                </div>
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                    </div>
                    <div class="drop-zone-text">
                        <h3>Arrastra tus audios aqu√≠</h3>
                        <p>o haz clic para seleccionar</p>
                        <small>MP3, WAV, OGG, M4A, WEBM (m√°x 25MB c/u)</small>
                    </div>
                    <input type="file" class="file-input" id="fileInput" accept="audio/*,.ogg,.mp3,.wav,.m4a,.webm,.flac" multiple>
                </div>

                <div class="file-list" id="fileList"></div>

                <div class="processing-status" id="processingStatus">
                    <div class="processing-header">
                        <div class="processing-spinner"></div>
                        <span class="processing-text" id="processingText">Procesando...</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <button class="btn btn-primary btn-full" id="transcribeBtn" disabled style="margin-top: 1rem;">
                    <svg viewBox="0 0 24 24" fill="white"><path d="M12 15c1.66 0 2.99-1.34 2.99-3L15 6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 15 6.7 12H5c0 3.42 2.72 6.23 6 6.72V22h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/></svg>
                    Transcribir Audios
                </button>
                <button class="btn btn-secondary btn-full" id="resetBtn" style="margin-top: 0.5rem;">
                    <svg viewBox="0 0 24 24"><path d="M19 8l-4 4h3c0 3.31-2.69 6-6 6-1.01 0-1.97-.25-2.8-.7l-1.46 1.46C8.97 19.54 10.43 20 12 20c4.42 0 8-3.58 8-8h3l-4-4zM6 12c0-3.31 2.69-6 6-6 1.01 0 1.97.25 2.8.7l1.46-1.46C15.03 4.46 13.57 4 12 4c-4.42 0-8 3.58-8 8H1l4 4 4-4H6z"/></svg>
                    Limpiar Todo
                </button>
            </div>

            <div class="card">
                <div class="card-title">
                    <svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
                    API Key Groq
                </div>
                <input type="password" id="apiKeyInput" placeholder="Ingresa tu API Key de Groq" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 0.85rem; margin-bottom: 0.5rem;">
                <button class="btn btn-secondary btn-full" id="saveApiKey" style="font-size: 0.8rem;">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                    Guardar API Key
                </button>
                <p style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.5rem;">
                    Obt√©n tu key gratis en <a href="https://console.groq.com/keys" target="_blank" style="color: var(--primary);">console.groq.com</a>
                </p>
            </div>

            <div class="card">
                <div class="card-title">
                    <svg viewBox="0 0 24 24"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6A4.997 4.997 0 017 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/></svg>
                    Info
                </div>
                <ul style="font-size: 0.8rem; color: var(--text-secondary); padding-left: 1.25rem; display: flex; flex-direction: column; gap: 0.25rem;">
                    <li>‚ö° Transcripci√≥n ultra r√°pida</li>
                    <li>üéØ Alta precisi√≥n m√©dica</li>
                    <li>‚úèÔ∏è Edita mientras procesa</li>
                    <li>üìÑ Exporta a Word</li>
                </ul>
            </div>
        </aside>

        <section class="editor-area">
            <div class="editor-header">
                <h2 class="editor-title">Informes M√©dicos Transcritos</h2>
                <div class="editor-actions">
                    <button class="btn btn-secondary" id="copyBtn" disabled>
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                        Copiar
                    </button>
                    <button class="btn btn-accent" id="downloadBtn" disabled>
                        <svg viewBox="0 0 24 24" fill="white"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                        Descargar Word
                    </button>
                </div>
            </div>

            <div class="editor-container">
                <div class="tabs-container" id="tabsContainer"></div>
                <div class="editor-toolbar no-tabs" id="editorToolbar">
                    <button class="toolbar-btn" title="Negrita" onclick="formatText('bold')">
                        <svg viewBox="0 0 24 24"><path d="M15.6 10.79c.97-.67 1.65-1.77 1.65-2.79 0-2.26-1.75-4-4-4H7v14h7.04c2.09 0 3.71-1.7 3.71-3.79 0-1.52-.86-2.82-2.15-3.42zM10 6.5h3c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-3v-3zm3.5 9H10v-3h3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z"/></svg>
                    </button>
                    <button class="toolbar-btn" title="Cursiva" onclick="formatText('italic')">
                        <svg viewBox="0 0 24 24"><path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z"/></svg>
                    </button>
                    <button class="toolbar-btn" title="Subrayado" onclick="formatText('underline')">
                        <svg viewBox="0 0 24 24"><path d="M12 17c3.31 0 6-2.69 6-6V3h-2.5v8c0 1.93-1.57 3.5-3.5 3.5S8.5 12.93 8.5 11V3H6v8c0 3.31 2.69 6 6 6zm-7 2v2h14v-2H5z"/></svg>
                    </button>
                    <div class="toolbar-divider"></div>
                    <span class="word-count" id="wordCount">0 palabras</span>
                </div>
                <div class="editor-content" id="editor" contenteditable="true" data-placeholder="El texto transcrito aparecer√° aqu√≠. Puedes editarlo mientras se procesan m√°s audios..."></div>
            </div>
        </section>
    </main>

    <div class="print-header">
        <h1>INFORME M√âDICO</h1>
        <p id="printDate"></p>
    </div>

    <div class="toast" id="toast">
        <svg viewBox="0 0 24 24"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
        <span id="toastMessage">Operaci√≥n completada</span>
    </div>

    <script>
        // GROQ API Configuration - User provides their own key
        let GROQ_API_KEY = localStorage.getItem('groq_api_key') || '';
        const GROQ_API_URL = 'https://api.groq.com/openai/v1/audio/transcriptions';

        // Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const transcribeBtn = document.getElementById('transcribeBtn');
        const processingStatus = document.getElementById('processingStatus');
        const processingText = document.getElementById('processingText');
        const progressFill = document.getElementById('progressFill');
        const editor = document.getElementById('editor');
        const wordCount = document.getElementById('wordCount');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKey');

        // Load saved API key
        if (GROQ_API_KEY) {
            apiKeyInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            apiKeyInput.dataset.hasKey = 'true';
        }

        // Save API Key
        saveApiKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key && !key.includes('‚Ä¢')) {
                localStorage.setItem('groq_api_key', key);
                GROQ_API_KEY = key;
                apiKeyInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                apiKeyInput.dataset.hasKey = 'true';
                showToast('API Key guardada correctamente', 'success');
            } else if (!apiKeyInput.dataset.hasKey) {
                showToast('Ingresa una API Key v√°lida', 'error');
            }
        });

        apiKeyInput.addEventListener('focus', () => {
            if (apiKeyInput.dataset.hasKey) {
                apiKeyInput.value = '';
                apiKeyInput.type = 'text';
            }
        });

        apiKeyInput.addEventListener('blur', () => {
            if (apiKeyInput.value === '' && GROQ_API_KEY) {
                apiKeyInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                apiKeyInput.type = 'password';
            }
        });

        let uploadedFiles = [];
        let transcriptions = [];
        let activeTranscriptionIndex = 0;
        let isProcessing = false;

        // Drop Zone Events
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleFiles(files) {
            const validExtensions = ['.mp3', '.wav', '.ogg', '.m4a', '.webm', '.flac', '.aac', '.opus'];
            const audioFiles = Array.from(files).filter(file => {
                if (file.type.startsWith('audio/')) return true;
                return validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
            });

            if (audioFiles.length === 0) {
                showToast('Por favor, sube archivos de audio v√°lidos', 'error');
                return;
            }

            // Check file size (25MB max for Groq)
            const validFiles = audioFiles.filter(f => f.size <= 25 * 1024 * 1024);
            if (validFiles.length < audioFiles.length) {
                showToast('Algunos archivos superan 25MB y fueron ignorados', 'error');
            }

            uploadedFiles = [...uploadedFiles, ...validFiles.map(f => ({ file: f, status: 'pending' }))];
            updateFileList();
            transcribeBtn.disabled = false;
        }

        function updateFileList() {
            fileList.innerHTML = uploadedFiles.map((item, index) => `
                <div class="file-item">
                    <div class="file-item-icon ${item.status}">
                        <svg viewBox="0 0 24 24"><path d="${item.status === 'done' ? 'M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z' : 'M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z'}"/></svg>
                    </div>
                    <div class="file-item-info">
                        <div class="file-item-name">${item.file.name}</div>
                        <div class="file-item-status">${formatFileSize(item.file.size)} ‚Ä¢ ${item.status === 'done' ? '‚úì Listo' : item.status === 'processing' ? '‚è≥ Procesando...' : 'Pendiente'}</div>
                    </div>
                    ${!isProcessing ? `<button class="file-item-remove" onclick="removeFile(${index})">
                        <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                    </button>` : ''}
                </div>
            `).join('');
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
            transcribeBtn.disabled = uploadedFiles.length === 0;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Transcribe with Groq API
        async function transcribeWithGroq(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('model', 'whisper-large-v3');
            formData.append('language', 'es');
            formData.append('response_format', 'text');

            const response = await fetch(GROQ_API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${GROQ_API_KEY}`
                },
                body: formData
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(`Error API: ${response.status}`);
            }

            return await response.text();
        }

        // Main transcription handler
        transcribeBtn.addEventListener('click', async () => {
            if (uploadedFiles.length === 0 || isProcessing) return;

            if (!GROQ_API_KEY) {
                showToast('Primero ingresa tu API Key de Groq', 'error');
                apiKeyInput.focus();
                return;
            }

            isProcessing = true;
            processingStatus.classList.add('active');
            transcribeBtn.disabled = true;

            const pendingFiles = uploadedFiles.filter(f => f.status === 'pending');
            let completed = 0;

            for (let i = 0; i < pendingFiles.length; i++) {
                const item = pendingFiles[i];
                const fileIndex = uploadedFiles.indexOf(item);
                
                item.status = 'processing';
                updateFileList();
                processingText.textContent = `Transcribiendo ${completed + 1}/${pendingFiles.length}: ${item.file.name}`;
                progressFill.style.width = `${(completed / pendingFiles.length) * 100}%`;

                try {
                    const text = await transcribeWithGroq(item.file);
                    
                    item.status = 'done';
                    completed++;
                    
                    // Add transcription immediately
                    transcriptions.push({
                        fileName: item.file.name,
                        text: text.trim() || 'No se detect√≥ audio.',
                        success: true
                    });

                    // Show result immediately
                    if (transcriptions.length === 1) {
                        editor.innerHTML = transcriptions[0].text;
                        updateWordCount();
                        copyBtn.disabled = false;
                        downloadBtn.disabled = false;
                    }
                    
                    createTabs();
                    updateFileList();
                    progressFill.style.width = `${(completed / pendingFiles.length) * 100}%`;

                } catch (error) {
                    console.error('Error:', error);
                    item.status = 'pending';
                    showToast(`Error en ${item.file.name}: ${error.message}`, 'error');
                }
            }

            progressFill.style.width = '100%';
            processingText.textContent = `‚úì ${completed} archivo(s) transcrito(s)`;
            
            setTimeout(() => {
                processingStatus.classList.remove('active');
                if (completed > 0) showToast(`${completed} transcripci√≥n(es) completada(s)`, 'success');
            }, 1000);

            isProcessing = false;
            transcribeBtn.disabled = uploadedFiles.every(f => f.status === 'done');
        });

        // Tabs
        function createTabs() {
            const tabsContainer = document.getElementById('tabsContainer');
            const editorToolbar = document.getElementById('editorToolbar');
            
            if (transcriptions.length <= 1) {
                tabsContainer.classList.remove('active');
                editorToolbar.classList.add('no-tabs');
                return;
            }

            tabsContainer.classList.add('active');
            editorToolbar.classList.remove('no-tabs');
            
            tabsContainer.innerHTML = transcriptions.map((t, i) => `
                <button class="tab ${i === activeTranscriptionIndex ? 'active' : ''}" onclick="switchTab(${i})">
                    ${t.fileName.length > 15 ? t.fileName.substring(0, 12) + '...' : t.fileName}
                    <span class="tab-close" onclick="event.stopPropagation(); closeTab(${i})">
                        <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                    </span>
                </button>
            `).join('');
        }

        function switchTab(index) {
            if (transcriptions[activeTranscriptionIndex]) {
                transcriptions[activeTranscriptionIndex].text = editor.innerHTML;
            }
            activeTranscriptionIndex = index;
            editor.innerHTML = transcriptions[index].text;
            updateWordCount();
            createTabs();
        }

        function closeTab(index) {
            transcriptions.splice(index, 1);
            if (transcriptions.length === 0) {
                editor.innerHTML = '';
                copyBtn.disabled = true;
                downloadBtn.disabled = true;
            } else {
                activeTranscriptionIndex = Math.min(activeTranscriptionIndex, transcriptions.length - 1);
                editor.innerHTML = transcriptions[activeTranscriptionIndex].text;
            }
            updateWordCount();
            createTabs();
        }

        // Word count
        function updateWordCount() {
            const text = editor.innerText.trim();
            const words = text ? text.split(/\s+/).length : 0;
            wordCount.textContent = `${words} palabras`;
        }
        editor.addEventListener('input', updateWordCount);

        // Format text
        function formatText(cmd) { document.execCommand(cmd, false, null); editor.focus(); }

        // Copy
        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(editor.innerText);
                showToast('Texto copiado', 'success');
            } catch (e) {
                showToast('Error al copiar', 'error');
            }
        });

        // Download Word
        downloadBtn.addEventListener('click', async () => {
            const text = editor.innerText || '';
            if (!text.trim()) {
                showToast('No hay texto para descargar', 'error');
                return;
            }

            const fileName = transcriptions[activeTranscriptionIndex]?.fileName?.replace(/\.[^/.]+$/, '') || 'informe';
            const dateStr = new Date().toLocaleDateString('es-ES');
            const fileDate = new Date().toISOString().split('T')[0];

            // Crear RTF (funciona en Word, OpenOffice, LibreOffice, Google Docs)
            const rtfContent = createRTF(text, dateStr);
            
            const blob = new Blob([rtfContent], { type: 'application/rtf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}_${fileDate}.rtf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Documento RTF descargado (compatible con Word/OpenOffice)', 'success');
        });

        // Crear documento RTF
        function createRTF(text, fecha) {
            const lines = text.split('\n');
            let rtfBody = '';
            
            for (const line of lines) {
                // Escapar caracteres especiales RTF
                const escaped = line
                    .replace(/\\/g, '\\\\')
                    .replace(/\{/g, '\\{')
                    .replace(/\}/g, '\\}')
                    .replace(/[√°√†√§√¢]/g, "\\'e1")
                    .replace(/[√©√®√´√™]/g, "\\'e9")
                    .replace(/[√≠√¨√Ø√Æ]/g, "\\'ed")
                    .replace(/[√≥√≤√∂√¥]/g, "\\'f3")
                    .replace(/[√∫√π√º√ª]/g, "\\'fa")
                    .replace(/√±/g, "\\'f1")
                    .replace(/√ë/g, "\\'d1")
                    .replace(/[√Å√Ä√Ñ√Ç]/g, "\\'c1")
                    .replace(/[√â√à√ã√ä]/g, "\\'c9")
                    .replace(/[√ç√å√è√é]/g, "\\'cd")
                    .replace(/[√ì√í√ñ√î]/g, "\\'d3")
                    .replace(/[√ö√ô√ú√õ]/g, "\\'da");
                rtfBody += escaped + '\\par\n';
            }

            return `{\\rtf1\\ansi\\deff0
{\\fonttbl{\\f0 Arial;}{\\f1 Times New Roman;}}
{\\colortbl;\\red0\\green0\\blue0;\\red102\\green102\\blue102;}
\\paperw12240\\paperh15840\\margl1440\\margr1440\\margt1440\\margb1440
\\qc\\f0\\fs36\\b INFORME M\\'c9DICO\\b0\\par
\\fs24\\cf2\\i Fecha: ${fecha}\\i0\\cf1\\par
\\par
\\ql\\f1\\fs24
${rtfBody}
}`; 
        }

        // Reset
        resetBtn.addEventListener('click', () => {
            uploadedFiles = [];
            transcriptions = [];
            activeTranscriptionIndex = 0;
            isProcessing = false;
            editor.innerHTML = '';
            fileInput.value = '';
            updateFileList();
            createTabs();
            updateWordCount();
            transcribeBtn.disabled = true;
            copyBtn.disabled = true;
            downloadBtn.disabled = true;
            processingStatus.classList.remove('active');
            showToast('Todo limpio, listo para empezar', 'success');
        });

        // Toast
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
