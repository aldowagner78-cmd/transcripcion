<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Transcriptor M√©dico Pro | Audio a Texto</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #0f766e;
            --primary-light: #14b8a6;
            --primary-dark: #0d5c56;
            --accent: #f59e0b;
            --bg-main: #f1f5f9;
            --bg-card: #ffffff;
            --bg-hover: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --radius: 16px;
            --radius-sm: 10px;
        }

        [data-theme="dark"] {
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 20px rgba(15, 118, 110, 0.3);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: white;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: var(--radius-sm);
            display: grid;
            place-items: center;
        }

        .logo-icon svg { width: 22px; height: 22px; fill: white; }
        .logo h1 { font-size: 1.1rem; font-weight: 700; }
        .logo span { font-size: 0.7rem; opacity: 0.8; display: block; }

        .header-actions { display: flex; gap: 0.5rem; align-items: center; }

        .theme-toggle {
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255,255,255,0.15);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: grid;
            place-items: center;
            transition: all 0.2s;
        }

        .theme-toggle:hover { background: rgba(255,255,255,0.25); }
        .theme-toggle svg { width: 20px; height: 20px; fill: white; }

        /* Main Layout */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 1.5rem;
            min-height: calc(100vh - 70px);
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.25rem;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .card-title {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title svg { width: 16px; height: 16px; fill: var(--primary); }

        /* Sidebar */
        .sidebar { display: flex; flex-direction: column; gap: 1rem; }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, rgba(15,118,110,0.03), rgba(15,118,110,0.08));
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(15,118,110,0.05), rgba(15,118,110,0.12));
            transform: scale(1.01);
        }

        .drop-zone-icon {
            width: 56px;
            height: 56px;
            margin: 0 auto 0.75rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 50%;
            display: grid;
            place-items: center;
        }

        .drop-zone-icon svg { width: 24px; height: 24px; fill: white; }
        .drop-zone h3 { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.25rem; }
        .drop-zone p { font-size: 0.8rem; color: var(--text-secondary); }
        .drop-zone small { font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.5rem; display: block; }

        .file-input { display: none; }

        /* Audio Enhancement Options */
        .audio-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .audio-option {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.4rem 0.6rem;
            background: var(--bg-main);
            border-radius: 6px;
            transition: all 0.2s;
        }

        .audio-option:hover { background: var(--bg-hover); color: var(--primary); }
        .audio-option input { accent-color: var(--primary); }
        .audio-option.active { background: rgba(15,118,110,0.1); color: var(--primary); }

        /* File List */
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            max-height: 180px;
            overflow-y: auto;
            margin-top: 0.75rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.5rem;
            background: var(--bg-main);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            font-size: 0.8rem;
        }

        .file-item-icon {
            width: 28px;
            height: 28px;
            background: var(--accent);
            border-radius: 6px;
            display: grid;
            place-items: center;
            flex-shrink: 0;
        }

        .file-item-icon svg { width: 14px; height: 14px; fill: white; }
        .file-item-icon.done { background: #22c55e; }
        .file-item-icon.processing { background: var(--primary); animation: pulse 1s infinite; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .file-item-info { flex: 1; min-width: 0; }
        .file-item-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-item-status { font-size: 0.7rem; color: var(--text-secondary); }

        .file-item-remove {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 50%;
            display: grid;
            place-items: center;
            opacity: 0.5;
            transition: all 0.2s;
        }

        .file-item-remove:hover { background: #fee2e2; opacity: 1; }
        .file-item-remove svg { width: 12px; height: 12px; fill: #ef4444; }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.7rem 1rem;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn svg { width: 16px; height: 16px; }
        .btn-full { width: 100%; }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(15,118,110,0.3);
        }

        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(15,118,110,0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-secondary {
            background: var(--bg-main);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover { border-color: var(--primary); color: var(--primary); }
        .btn-secondary svg { fill: currentColor; }

        .btn-accent {
            background: linear-gradient(135deg, var(--accent), #f97316);
            color: white;
        }

        /* Processing Status */
        .processing-status {
            display: none;
            padding: 0.75rem;
            background: linear-gradient(135deg, rgba(15,118,110,0.05), rgba(15,118,110,0.1));
            border-radius: var(--radius-sm);
            margin-top: 0.75rem;
        }

        .processing-status.active { display: block; }

        .processing-header {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-bottom: 0.5rem;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .processing-text { font-size: 0.75rem; font-weight: 500; color: var(--primary-dark); }

        .progress-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary-light)); width: 0%; transition: width 0.3s; }

        /* API Key Section */
        .api-section { display: flex; flex-direction: column; gap: 0.5rem; }

        .api-input {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            background: var(--bg-main);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .api-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(15,118,110,0.1); }

        .api-status {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.7rem;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
        }

        .api-status.connected { background: rgba(34,197,94,0.1); color: #16a34a; }
        .api-status.disconnected { background: rgba(239,68,68,0.1); color: #dc2626; }

        /* Editor Area */
        .editor-area { display: flex; flex-direction: column; gap: 1rem; }

        .editor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .editor-title { font-size: 1.25rem; font-weight: 700; }

        .editor-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }

        /* Download Dropdown */
        .dropdown { position: relative; }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow);
            min-width: 160px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
            z-index: 50;
        }

        .dropdown.open .dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.6rem 0.8rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            width: 100%;
            color: var(--text-primary);
        }

        .dropdown-item:hover { background: var(--bg-main); color: var(--primary); }
        .dropdown-item svg { width: 16px; height: 16px; fill: currentColor; }

        /* Tabs */
        .tabs-container {
            display: none;
            gap: 0.25rem;
            padding: 0.5rem 0.75rem 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-bottom: none;
            border-radius: var(--radius) var(--radius) 0 0;
            overflow-x: auto;
        }

        .tabs-container.active { display: flex; }

        .tab {
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.4rem;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .tab:hover { color: var(--primary); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }

        .tab-close {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            opacity: 0.5;
        }

        .tab-close:hover { opacity: 1; background: rgba(239,68,68,0.1); }
        .tab-close svg { width: 10px; height: 10px; fill: currentColor; }

        /* Editor Toolbar */
        .editor-toolbar {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.6rem 0.8rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-bottom: none;
            flex-wrap: wrap;
        }

        .editor-toolbar.no-tabs { border-radius: var(--radius) var(--radius) 0 0; }

        .toolbar-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 6px;
            display: grid;
            place-items: center;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .toolbar-btn:hover { background: var(--bg-main); color: var(--primary); }
        .toolbar-btn svg { width: 16px; height: 16px; fill: currentColor; }
        .toolbar-btn.active { background: rgba(15,118,110,0.1); color: var(--primary); }

        .toolbar-divider { width: 1px; height: 20px; background: var(--border); margin: 0 0.25rem; }

        .toolbar-select {
            padding: 0.3rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.75rem;
            background: var(--bg-main);
            color: var(--text-primary);
            cursor: pointer;
        }

        .toolbar-input {
            width: 140px;
            padding: 0.3rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.75rem;
            background: var(--bg-main);
            color: var(--text-primary);
        }

        .toolbar-input:focus { outline: none; border-color: var(--primary); }

        .word-count {
            margin-left: auto;
            font-size: 0.7rem;
            color: var(--text-secondary);
            background: var(--bg-main);
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
        }

        /* Editor Content */
        .editor-container { flex: 1; display: flex; flex-direction: column; }

        .editor-content {
            flex: 1;
            min-height: 450px;
            padding: 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--radius) var(--radius);
            font-size: 1rem;
            line-height: 1.8;
            outline: none;
            overflow-y: auto;
            white-space: pre-wrap;
            transition: all 0.2s;
        }

        .editor-content:focus { box-shadow: inset 0 0 0 2px rgba(15,118,110,0.15); }
        .editor-content:empty::before { content: attr(data-placeholder); color: var(--text-secondary); opacity: 0.5; font-style: italic; }

        /* Find & Replace Panel */
        .find-replace-panel {
            display: none;
            padding: 0.75rem;
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 0.75rem;
            gap: 0.5rem;
        }

        .find-replace-panel.active { display: flex; flex-wrap: wrap; }

        .find-replace-panel input {
            flex: 1;
            min-width: 120px;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.8rem;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .find-replace-panel input:focus { outline: none; border-color: var(--primary); }

        .find-replace-panel button {
            padding: 0.5rem 0.75rem;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .find-replace-panel button:hover { background: var(--primary-dark); }

        .find-replace-panel .close-btn {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            gap: 0.6rem;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
            font-size: 0.85rem;
            max-width: 90vw;
        }

        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .toast.error { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .toast svg { width: 18px; height: 18px; fill: white; flex-shrink: 0; }

        /* Mobile Responsive */
        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 1rem;
                gap: 1rem;
            }
            .sidebar { order: -1; }
            .header h1 { font-size: 1rem; }
            .editor-content { min-height: 350px; }
        }

        @media (max-width: 500px) {
            .header { padding: 0.75rem 1rem; }
            .logo span { display: none; }
            .editor-actions { width: 100%; justify-content: stretch; }
            .editor-actions .btn { flex: 1; font-size: 0.75rem; padding: 0.6rem; }
            .toolbar-input { width: 100px; }
            .card { padding: 1rem; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                </div>
                <div>
                    <h1>Transcriptor M√©dico Pro</h1>
                    <span>Audio ‚Üí Texto con IA</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" id="themeToggle" title="Cambiar tema">
                    <svg id="themeIcon" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
                </button>
            </div>
        </div>
    </header>

    <main class="main-container">
        <aside class="sidebar">
            <!-- Upload Card -->
            <div class="card">
                <div class="card-title">
                    <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                    Subir Audios
                </div>
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
                    </div>
                    <h3>Arrastra audios aqu√≠</h3>
                    <p>o toca para seleccionar</p>
                    <small>MP3, WAV, OGG, M4A ‚Ä¢ m√°x 25MB</small>
                    <input type="file" class="file-input" id="fileInput" accept="audio/*" multiple>
                </div>

                <!-- Audio Enhancement Options -->
                <div class="audio-options">
                    <label class="audio-option" id="optNormalize">
                        <input type="checkbox" id="chkNormalize" checked>
                        üîä Normalizar
                    </label>
                    <label class="audio-option" id="optNoise">
                        <input type="checkbox" id="chkNoise" checked>
                        üîá Reducir ruido
                    </label>
                    <label class="audio-option" id="optCompress">
                        <input type="checkbox" id="chkCompress">
                        üì¶ Comprimir
                    </label>
                </div>

                <div class="file-list" id="fileList"></div>

                <div class="processing-status" id="processingStatus">
                    <div class="processing-header">
                        <div class="spinner"></div>
                        <span class="processing-text" id="processingText">Procesando...</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <button class="btn btn-primary btn-full" id="transcribeBtn" disabled style="margin-top: 0.75rem;">
                    <svg viewBox="0 0 24 24" fill="white"><path d="M12 15c1.66 0 2.99-1.34 2.99-3L15 6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 15 6.7 12H5c0 3.42 2.72 6.23 6 6.72V22h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/></svg>
                    Transcribir
                </button>
                <button class="btn btn-secondary btn-full" id="resetBtn" style="margin-top: 0.5rem;">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                    Limpiar
                </button>
            </div>

            <!-- API Key Card -->
            <div class="card">
                <div class="card-title">
                    <svg viewBox="0 0 24 24"><path d="M12.65 10A5.99 5.99 0 007 6c-3.31 0-6 2.69-6 6s2.69 6 6 6a5.99 5.99 0 005.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                    API Key Groq
                </div>
                <div class="api-section">
                    <input type="password" class="api-input" id="apiKeyInput" placeholder="gsk_...">
                    <div class="api-status disconnected" id="apiStatus">
                        <svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        <span>No configurada</span>
                    </div>
                    <button class="btn btn-secondary btn-full" id="saveApiKey" style="font-size: 0.8rem;">
                        Guardar Key
                    </button>
                    <p style="font-size: 0.65rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        Gratis en <a href="https://console.groq.com/keys" target="_blank" style="color: var(--primary);">console.groq.com</a> ‚Ä¢ Se guarda localmente
                    </p>
                </div>
            </div>
        </aside>

        <!-- Editor Section -->
        <section class="editor-area">
            <div class="editor-header">
                <h2 class="editor-title">üìù Editor de Transcripci√≥n</h2>
                <div class="editor-actions">
                    <button class="btn btn-secondary" id="copyBtn" disabled>
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                        Copiar
                    </button>
                    <div class="dropdown" id="downloadDropdown">
                        <button class="btn btn-accent" id="downloadBtn" disabled>
                            <svg viewBox="0 0 24 24" fill="white"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                            Descargar ‚ñæ
                        </button>
                        <div class="dropdown-menu">
                            <button class="dropdown-item" data-format="rtf">
                                <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                                Word (.rtf)
                            </button>
                            <button class="dropdown-item" data-format="pdf">
                                <svg viewBox="0 0 24 24"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/></svg>
                                PDF (.pdf)
                            </button>
                            <button class="dropdown-item" data-format="txt">
                                <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg>
                                Texto (.txt)
                            </button>
                            <button class="dropdown-item" data-format="html">
                                <svg viewBox="0 0 24 24"><path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/></svg>
                                HTML (.html)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Find & Replace -->
            <div class="find-replace-panel" id="findReplacePanel">
                <input type="text" id="findInput" placeholder="Buscar...">
                <input type="text" id="replaceInput" placeholder="Reemplazar con...">
                <button id="findNextBtn">Siguiente</button>
                <button id="replaceBtn">Reemplazar</button>
                <button id="replaceAllBtn">Reemplazar todo</button>
                <button class="close-btn" id="closeFindReplace">‚úï</button>
            </div>

            <div class="editor-container">
                <div class="tabs-container" id="tabsContainer"></div>
                <div class="editor-toolbar no-tabs" id="editorToolbar">
                    <button class="toolbar-btn" title="Deshacer (Ctrl+Z)" id="undoBtn">
                        <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
                    </button>
                    <button class="toolbar-btn" title="Rehacer (Ctrl+Y)" id="redoBtn">
                        <svg viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>
                    </button>
                    <div class="toolbar-divider"></div>
                    <button class="toolbar-btn" title="Negrita (Ctrl+B)" onclick="formatText('bold')">
                        <svg viewBox="0 0 24 24"><path d="M15.6 10.79c.97-.67 1.65-1.77 1.65-2.79 0-2.26-1.75-4-4-4H7v14h7.04c2.09 0 3.71-1.7 3.71-3.79 0-1.52-.86-2.82-2.15-3.42zM10 6.5h3c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-3v-3zm3.5 9H10v-3h3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z"/></svg>
                    </button>
                    <button class="toolbar-btn" title="Cursiva (Ctrl+I)" onclick="formatText('italic')">
                        <svg viewBox="0 0 24 24"><path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z"/></svg>
                    </button>
                    <button class="toolbar-btn" title="Subrayado (Ctrl+U)" onclick="formatText('underline')">
                        <svg viewBox="0 0 24 24"><path d="M12 17c3.31 0 6-2.69 6-6V3h-2.5v8c0 1.93-1.57 3.5-3.5 3.5S8.5 12.93 8.5 11V3H6v8c0 3.31 2.69 6 6 6zm-7 2v2h14v-2H5z"/></svg>
                    </button>
                    <div class="toolbar-divider"></div>
                    <button class="toolbar-btn" title="Buscar y reemplazar (Ctrl+H)" id="toggleFindReplace">
                        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    </button>
                    <button class="toolbar-btn" title="Limpiar formato" onclick="formatText('removeFormat')">
                        <svg viewBox="0 0 24 24"><path d="M3.27 5L2 6.27l6.97 6.97L6.5 19h3l1.57-3.66L16.73 21 18 19.73 3.55 5.27 3.27 5zM6 5v.18L8.82 8h2.4l-.72 1.68 2.1 2.1L14.21 8H20V5H6z"/></svg>
                    </button>
                    <div class="toolbar-divider"></div>
                    <select class="toolbar-select" id="fontSizeSelect" title="Tama√±o de fuente">
                        <option value="14">14px</option>
                        <option value="16" selected>16px</option>
                        <option value="18">18px</option>
                        <option value="20">20px</option>
                        <option value="24">24px</option>
                    </select>
                    <span class="word-count" id="wordCount">0 palabras</span>
                </div>
                <div class="editor-content" id="editor" contenteditable="true" data-placeholder="El texto transcrito aparecer√° aqu√≠. Puedes editarlo mientras se procesan m√°s audios..."></div>
            </div>
        </section>
    </main>

    <div class="toast" id="toast">
        <svg viewBox="0 0 24 24"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
        <span id="toastMessage">Operaci√≥n completada</span>
    </div>

    <script>
        // ============ CONFIGURATION ============
        let GROQ_API_KEY = localStorage.getItem('groq_api_key') || '';
        const GROQ_API_URL = 'https://api.groq.com/openai/v1/audio/transcriptions';

        // ============ DOM ELEMENTS ============
        const $ = id => document.getElementById(id);
        const dropZone = $('dropZone');
        const fileInput = $('fileInput');
        const fileList = $('fileList');
        const transcribeBtn = $('transcribeBtn');
        const processingStatus = $('processingStatus');
        const processingText = $('processingText');
        const progressFill = $('progressFill');
        const editor = $('editor');
        const wordCount = $('wordCount');
        const copyBtn = $('copyBtn');
        const downloadBtn = $('downloadBtn');
        const downloadDropdown = $('downloadDropdown');
        const resetBtn = $('resetBtn');
        const toast = $('toast');
        const toastMessage = $('toastMessage');
        const apiKeyInput = $('apiKeyInput');
        const saveApiKeyBtn = $('saveApiKey');
        const apiStatus = $('apiStatus');
        const themeToggle = $('themeToggle');
        const fontSizeSelect = $('fontSizeSelect');
        const findReplacePanel = $('findReplacePanel');
        const findInput = $('findInput');
        const replaceInput = $('replaceInput');

        // Audio options
        const chkNormalize = $('chkNormalize');
        const chkNoise = $('chkNoise');
        const chkCompress = $('chkCompress');

        // ============ STATE ============
        let uploadedFiles = [];
        let transcriptions = [];
        let activeTabIndex = 0;
        let isProcessing = false;
        let undoStack = [];
        let redoStack = [];

        // ============ THEME ============
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
        updateThemeIcon();

        themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
            updateThemeIcon();
        });

        function updateThemeIcon() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            $('themeIcon').innerHTML = isDark 
                ? '<path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>'
                : '<path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>';
        }

        // ============ API KEY ============
        function updateApiStatus() {
            if (GROQ_API_KEY) {
                apiStatus.className = 'api-status connected';
                apiStatus.innerHTML = '<svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg><span>Conectada ‚úì</span>';
                apiKeyInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                apiKeyInput.dataset.hasKey = 'true';
            } else {
                apiStatus.className = 'api-status disconnected';
                apiStatus.innerHTML = '<svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg><span>No configurada</span>';
            }
        }
        updateApiStatus();

        saveApiKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key && !key.includes('‚Ä¢') && key.startsWith('gsk_')) {
                localStorage.setItem('groq_api_key', key);
                GROQ_API_KEY = key;
                updateApiStatus();
                showToast('API Key guardada ‚úì', 'success');
            } else if (!apiKeyInput.dataset.hasKey) {
                showToast('Ingresa una API Key v√°lida (empieza con gsk_)', 'error');
            }
        });

        apiKeyInput.addEventListener('focus', () => {
            if (apiKeyInput.dataset.hasKey) {
                apiKeyInput.value = '';
                apiKeyInput.type = 'text';
            }
        });

        apiKeyInput.addEventListener('blur', () => {
            if (apiKeyInput.value === '' && GROQ_API_KEY) {
                apiKeyInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                apiKeyInput.type = 'password';
            }
        });

        // ============ AUDIO PROCESSING ============
        async function processAudio(file) {
            const shouldNormalize = chkNormalize.checked;
            const shouldReduceNoise = chkNoise.checked;
            const shouldCompress = chkCompress.checked;

            if (!shouldNormalize && !shouldReduceNoise && !shouldCompress) {
                return file; // No processing needed
            }

            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const arrayBuffer = await file.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

                // Create offline context for processing
                const offlineContext = new OfflineAudioContext(
                    audioBuffer.numberOfChannels,
                    audioBuffer.length,
                    audioBuffer.sampleRate
                );

                const source = offlineContext.createBufferSource();
                source.buffer = audioBuffer;

                let currentNode = source;

                // Normalize (gain adjustment)
                if (shouldNormalize) {
                    const gainNode = offlineContext.createGain();
                    // Find peak and normalize
                    let peak = 0;
                    for (let c = 0; c < audioBuffer.numberOfChannels; c++) {
                        const data = audioBuffer.getChannelData(c);
                        for (let i = 0; i < data.length; i++) {
                            peak = Math.max(peak, Math.abs(data[i]));
                        }
                    }
                    gainNode.gain.value = peak > 0 ? 0.95 / peak : 1;
                    currentNode.connect(gainNode);
                    currentNode = gainNode;
                }

                // Noise reduction (high-pass filter to remove low-frequency noise)
                if (shouldReduceNoise) {
                    const highpass = offlineContext.createBiquadFilter();
                    highpass.type = 'highpass';
                    highpass.frequency.value = 80; // Remove frequencies below 80Hz
                    currentNode.connect(highpass);
                    currentNode = highpass;

                    // Also add a subtle lowpass to remove high-frequency hiss
                    const lowpass = offlineContext.createBiquadFilter();
                    lowpass.type = 'lowpass';
                    lowpass.frequency.value = 12000;
                    currentNode.connect(lowpass);
                    currentNode = lowpass;
                }

                // Compressor for dynamic range
                if (shouldCompress) {
                    const compressor = offlineContext.createDynamicsCompressor();
                    compressor.threshold.value = -24;
                    compressor.knee.value = 30;
                    compressor.ratio.value = 4;
                    compressor.attack.value = 0.003;
                    compressor.release.value = 0.25;
                    currentNode.connect(compressor);
                    currentNode = compressor;
                }

                currentNode.connect(offlineContext.destination);
                source.start(0);

                const renderedBuffer = await offlineContext.startRendering();
                
                // Convert to WAV blob
                const wavBlob = audioBufferToWav(renderedBuffer);
                return new File([wavBlob], file.name.replace(/\.[^/.]+$/, '.wav'), { type: 'audio/wav' });

            } catch (error) {
                console.warn('Audio processing failed, using original:', error);
                return file;
            }
        }

        function audioBufferToWav(buffer) {
            const numChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const format = 1; // PCM
            const bitDepth = 16;
            
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numChannels * bytesPerSample;
            
            const dataLength = buffer.length * blockAlign;
            const bufferLength = 44 + dataLength;
            
            const arrayBuffer = new ArrayBuffer(bufferLength);
            const view = new DataView(arrayBuffer);
            
            // WAV header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);
            
            // Write audio data
            const offset = 44;
            const channels = [];
            for (let i = 0; i < numChannels; i++) {
                channels.push(buffer.getChannelData(i));
            }
            
            for (let i = 0; i < buffer.length; i++) {
                for (let c = 0; c < numChannels; c++) {
                    const sample = Math.max(-1, Math.min(1, channels[c][i]));
                    const intSample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                    view.setInt16(offset + (i * blockAlign) + (c * bytesPerSample), intSample, true);
                }
            }
            
            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // ============ FILE HANDLING ============
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', e => handleFiles(e.target.files));

        function handleFiles(files) {
            const audioFiles = Array.from(files).filter(f => f.type.startsWith('audio/') || /\.(mp3|wav|ogg|m4a|webm|flac)$/i.test(f.name));
            
            if (!audioFiles.length) {
                showToast('Selecciona archivos de audio v√°lidos', 'error');
                return;
            }

            const validFiles = audioFiles.filter(f => f.size <= 25 * 1024 * 1024);
            if (validFiles.length < audioFiles.length) {
                showToast('Archivos >25MB ignorados', 'error');
            }

            uploadedFiles.push(...validFiles.map(f => ({ file: f, status: 'pending' })));
            updateFileList();
            transcribeBtn.disabled = false;
        }

        function updateFileList() {
            fileList.innerHTML = uploadedFiles.map((item, i) => `
                <div class="file-item">
                    <div class="file-item-icon ${item.status}">
                        <svg viewBox="0 0 24 24"><path d="${item.status === 'done' ? 'M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z' : 'M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z'}"/></svg>
                    </div>
                    <div class="file-item-info">
                        <div class="file-item-name">${item.file.name}</div>
                        <div class="file-item-status">${formatSize(item.file.size)} ‚Ä¢ ${item.status === 'done' ? '‚úì Listo' : item.status === 'processing' ? 'Procesando...' : 'Pendiente'}</div>
                    </div>
                    ${!isProcessing ? `<button class="file-item-remove" onclick="removeFile(${i})"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>` : ''}
                </div>
            `).join('');
        }

        window.removeFile = i => {
            uploadedFiles.splice(i, 1);
            updateFileList();
            transcribeBtn.disabled = !uploadedFiles.length;
        };

        function formatSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024, sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(1) + ' ' + sizes[i];
        }

        // ============ TRANSCRIPTION ============
        transcribeBtn.addEventListener('click', async () => {
            if (!uploadedFiles.length || isProcessing) return;
            if (!GROQ_API_KEY) {
                showToast('Primero configura tu API Key', 'error');
                apiKeyInput.focus();
                return;
            }

            isProcessing = true;
            processingStatus.classList.add('active');
            transcribeBtn.disabled = true;

            const pending = uploadedFiles.filter(f => f.status === 'pending');
            let done = 0;

            for (const item of pending) {
                item.status = 'processing';
                updateFileList();
                processingText.textContent = `${done + 1}/${pending.length}: ${item.file.name}`;
                progressFill.style.width = `${(done / pending.length) * 100}%`;

                try {
                    // Process audio before sending
                    processingText.textContent = `Mejorando audio: ${item.file.name}`;
                    const processedFile = await processAudio(item.file);
                    
                    processingText.textContent = `Transcribiendo: ${item.file.name}`;
                    const text = await transcribeWithGroq(processedFile);
                    
                    item.status = 'done';
                    done++;
                    
                    transcriptions.push({ fileName: item.file.name, text: text.trim() || 'Sin audio detectado.' });

                    if (transcriptions.length === 1) {
                        editor.innerHTML = transcriptions[0].text;
                        updateWordCount();
                        enableButtons();
                    }
                    
                    createTabs();
                    updateFileList();
                    progressFill.style.width = `${(done / pending.length) * 100}%`;

                } catch (err) {
                    console.error(err);
                    item.status = 'pending';
                    showToast(`Error: ${err.message}`, 'error');
                }
            }

            progressFill.style.width = '100%';
            processingText.textContent = `‚úì ${done} transcrito(s)`;
            setTimeout(() => {
                processingStatus.classList.remove('active');
                if (done) showToast(`${done} transcripci√≥n(es) lista(s)`, 'success');
            }, 1000);

            isProcessing = false;
            transcribeBtn.disabled = uploadedFiles.every(f => f.status === 'done');
        });

        async function transcribeWithGroq(file) {
            const form = new FormData();
            form.append('file', file);
            form.append('model', 'whisper-large-v3');
            form.append('language', 'es');
            form.append('response_format', 'text');

            const res = await fetch(GROQ_API_URL, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${GROQ_API_KEY}` },
                body: form
            });

            if (!res.ok) throw new Error(`API ${res.status}`);
            return await res.text();
        }

        // ============ TABS ============
        function createTabs() {
            const container = $('tabsContainer');
            const toolbar = $('editorToolbar');
            
            if (transcriptions.length <= 1) {
                container.classList.remove('active');
                toolbar.classList.add('no-tabs');
                return;
            }

            container.classList.add('active');
            toolbar.classList.remove('no-tabs');
            
            container.innerHTML = transcriptions.map((t, i) => `
                <button class="tab ${i === activeTabIndex ? 'active' : ''}" onclick="switchTab(${i})">
                    ${t.fileName.length > 12 ? t.fileName.slice(0, 10) + '...' : t.fileName}
                    <span class="tab-close" onclick="event.stopPropagation(); closeTab(${i})">
                        <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                    </span>
                </button>
            `).join('');
        }

        window.switchTab = i => {
            if (transcriptions[activeTabIndex]) transcriptions[activeTabIndex].text = editor.innerHTML;
            activeTabIndex = i;
            editor.innerHTML = transcriptions[i].text;
            updateWordCount();
            createTabs();
        };

        window.closeTab = i => {
            transcriptions.splice(i, 1);
            if (!transcriptions.length) {
                editor.innerHTML = '';
                disableButtons();
            } else {
                activeTabIndex = Math.min(activeTabIndex, transcriptions.length - 1);
                editor.innerHTML = transcriptions[activeTabIndex].text;
            }
            updateWordCount();
            createTabs();
        };

        // ============ EDITOR ============
        function updateWordCount() {
            const text = editor.innerText.trim();
            const words = text ? text.split(/\s+/).length : 0;
            wordCount.textContent = `${words} palabras`;
            
            const hasText = text.length > 0;
            copyBtn.disabled = !hasText;
            downloadBtn.disabled = !hasText;
        }

        editor.addEventListener('input', () => {
            updateWordCount();
            saveUndoState();
        });

        window.formatText = cmd => { document.execCommand(cmd, false, null); editor.focus(); };

        fontSizeSelect.addEventListener('change', () => {
            editor.style.fontSize = fontSizeSelect.value + 'px';
        });

        // Undo/Redo
        function saveUndoState() {
            undoStack.push(editor.innerHTML);
            if (undoStack.length > 50) undoStack.shift();
            redoStack = [];
        }

        $('undoBtn').addEventListener('click', () => {
            if (undoStack.length > 1) {
                redoStack.push(undoStack.pop());
                editor.innerHTML = undoStack[undoStack.length - 1] || '';
                updateWordCount();
            }
        });

        $('redoBtn').addEventListener('click', () => {
            if (redoStack.length) {
                const state = redoStack.pop();
                undoStack.push(state);
                editor.innerHTML = state;
                updateWordCount();
            }
        });

        // Find & Replace
        $('toggleFindReplace').addEventListener('click', () => {
            findReplacePanel.classList.toggle('active');
            if (findReplacePanel.classList.contains('active')) findInput.focus();
        });

        $('closeFindReplace').addEventListener('click', () => findReplacePanel.classList.remove('active'));

        $('findNextBtn').addEventListener('click', () => {
            const text = findInput.value;
            if (!text) return;
            const selection = window.getSelection();
            const range = document.createRange();
            const content = editor.innerText;
            const start = content.indexOf(text, selection.anchorOffset || 0);
            if (start >= 0) {
                highlightText(text);
            } else {
                showToast('No encontrado', 'error');
            }
        });

        $('replaceBtn').addEventListener('click', () => {
            const find = findInput.value;
            const replace = replaceInput.value;
            if (!find) return;
            const html = editor.innerHTML;
            const newHtml = html.replace(find, replace);
            if (html !== newHtml) {
                saveUndoState();
                editor.innerHTML = newHtml;
                updateWordCount();
                showToast('Reemplazado', 'success');
            }
        });

        $('replaceAllBtn').addEventListener('click', () => {
            const find = findInput.value;
            const replace = replaceInput.value;
            if (!find) return;
            saveUndoState();
            const regex = new RegExp(escapeRegex(find), 'gi');
            const text = editor.innerText;
            const count = (text.match(regex) || []).length;
            editor.innerText = text.replace(regex, replace);
            updateWordCount();
            showToast(`${count} reemplazado(s)`, 'success');
        });

        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function highlightText(text) {
            const content = editor.innerHTML;
            const highlighted = content.replace(new RegExp(`(${escapeRegex(text)})`, 'gi'), '<mark>$1</mark>');
            editor.innerHTML = highlighted;
        }

        // ============ COPY ============
        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(editor.innerText);
                showToast('Copiado ‚úì', 'success');
            } catch { showToast('Error al copiar', 'error'); }
        });

        // ============ DOWNLOAD ============
        downloadBtn.addEventListener('click', () => {
            downloadDropdown.classList.toggle('open');
        });

        document.addEventListener('click', e => {
            if (!downloadDropdown.contains(e.target)) {
                downloadDropdown.classList.remove('open');
            }
        });

        document.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', () => {
                const format = item.dataset.format;
                downloadFile(format);
                downloadDropdown.classList.remove('open');
            });
        });

        function downloadFile(format) {
            const text = editor.innerText || '';
            if (!text.trim()) return showToast('No hay texto', 'error');

            const fileName = transcriptions[activeTabIndex]?.fileName?.replace(/\.[^/.]+$/, '') || 'informe';
            const date = new Date().toLocaleDateString('es-ES');
            const fileDate = new Date().toISOString().split('T')[0];

            let blob, ext;

            switch (format) {
                case 'rtf':
                    blob = new Blob([createRTF(text, date)], { type: 'application/rtf' });
                    ext = 'rtf';
                    break;
                case 'pdf':
                    downloadPDF(text, fileName, date, fileDate);
                    return;
                case 'txt':
                    blob = new Blob([`INFORME M√âDICO\nFecha: ${date}\n\n${text}`], { type: 'text/plain;charset=utf-8' });
                    ext = 'txt';
                    break;
                case 'html':
                    blob = new Blob([createHTML(text, date)], { type: 'text/html;charset=utf-8' });
                    ext = 'html';
                    break;
            }

            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${fileName}_${fileDate}.${ext}`;
            a.click();
            URL.revokeObjectURL(a.href);
            showToast(`Descargado .${ext}`, 'success');
        }

        function createRTF(text, fecha) {
            const lines = text.split('\n');
            let body = '';
            for (const line of lines) {
                const escaped = line
                    .replace(/\\/g, '\\\\').replace(/\{/g, '\\{').replace(/\}/g, '\\}')
                    .replace(/[√°√†√§√¢]/g, "\\'e1").replace(/[√©√®√´√™]/g, "\\'e9").replace(/[√≠√¨√Ø√Æ]/g, "\\'ed")
                    .replace(/[√≥√≤√∂√¥]/g, "\\'f3").replace(/[√∫√π√º√ª]/g, "\\'fa").replace(/√±/g, "\\'f1")
                    .replace(/√ë/g, "\\'d1").replace(/[√Å√Ä√Ñ√Ç]/g, "\\'c1").replace(/[√â√à√ã√ä]/g, "\\'c9")
                    .replace(/[√ç√å√è√é]/g, "\\'cd").replace(/[√ì√í√ñ√î]/g, "\\'d3").replace(/[√ö√ô√ú√õ]/g, "\\'da");
                body += escaped + '\\par\n';
            }
            return `{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Arial;}}\\paperw12240\\paperh15840\\margl1440\\margr1440\\margt1440\\margb1440\\qc\\f0\\fs36\\b INFORME M\\'c9DICO\\b0\\par\\fs24\\i Fecha: ${fecha}\\i0\\par\\par\\ql\\fs24${body}}`;
        }

        function createHTML(text, fecha) {
            return `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Informe M√©dico</title>
<style>body{font-family:Georgia,serif;max-width:800px;margin:40px auto;padding:20px;line-height:1.8}
h1{text-align:center;border-bottom:2px solid #333;padding-bottom:10px}
.fecha{text-align:center;color:#666;font-style:italic}</style></head>
<body><h1>INFORME M√âDICO</h1><p class="fecha">Fecha: ${fecha}</p>
${text.split('\n').map(l => `<p>${l}</p>`).join('')}</body></html>`;
        }

        async function downloadPDF(text, fileName, fecha, fileDate) {
            if (typeof jspdf === 'undefined') {
                showToast('Cargando PDF...', 'success');
                await new Promise(r => setTimeout(r, 500));
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.text('INFORME M√âDICO', 105, 20, { align: 'center' });
                doc.setFontSize(12);
                doc.setTextColor(100);
                doc.text(`Fecha: ${fecha}`, 105, 30, { align: 'center' });
                
                doc.setTextColor(0);
                doc.setFontSize(11);
                
                const lines = doc.splitTextToSize(text, 170);
                let y = 45;
                
                for (const line of lines) {
                    if (y > 280) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(line, 20, y);
                    y += 7;
                }
                
                doc.save(`${fileName}_${fileDate}.pdf`);
                showToast('PDF descargado ‚úì', 'success');
            } catch (e) {
                console.error(e);
                showToast('Error al crear PDF', 'error');
            }
        }

        // ============ RESET ============
        resetBtn.addEventListener('click', () => {
            uploadedFiles = [];
            transcriptions = [];
            activeTabIndex = 0;
            isProcessing = false;
            editor.innerHTML = '';
            fileInput.value = '';
            updateFileList();
            createTabs();
            updateWordCount();
            transcribeBtn.disabled = true;
            disableButtons();
            processingStatus.classList.remove('active');
            showToast('Limpiado ‚úì', 'success');
        });

        // ============ HELPERS ============
        function enableButtons() { copyBtn.disabled = false; downloadBtn.disabled = false; }
        function disableButtons() { copyBtn.disabled = true; downloadBtn.disabled = true; }

        function showToast(msg, type = 'success') {
            toastMessage.textContent = msg;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', e => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'h' || e.key === 'H') {
                    e.preventDefault();
                    $('toggleFindReplace').click();
                }
            }
        });
    </script>
</body>
</html>
